<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste - Formata√ß√£o do Hist√≥rico</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-header {
            background: #dc3545;
            color: white;
            padding: 16px;
            margin: -20px -20px 20px -20px;
            border-radius: 12px 12px 0 0;
            text-align: center;
            font-weight: 600;
        }
        
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        
        .test-button:hover {
            background: #0056b3;
        }
        
        .test-output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .expected-format {
            background: #e8f5e8;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            üîç Teste de Formata√ß√£o do Hist√≥rico - Corre√ß√£o de Bugs
        </div>
        
        <div class="status error">
            <strong>üêõ Problema Identificado:</strong><br>
            - Role "assistant" n√£o est√° sendo enviada (deveria ser "assistant", n√£o "assistent")<br>
            - Mensagem do usu√°rio sendo duplicada ao inv√©s do hist√≥rico completo<br>
            - Falta de altern√¢ncia entre roles "user" e "assistant"
        </div>
        
        <div class="expected-format">
            <strong>üìã Formato Esperado:</strong><br>
            [<br>
            &nbsp;&nbsp;{"role": "system", "content": "Voc√™ √© um atendente..."},<br>
            &nbsp;&nbsp;{"role": "user", "content": "Primeira mensagem do usu√°rio"},<br>
            &nbsp;&nbsp;{"role": "assistant", "content": "Resposta do assistente"},<br>
            &nbsp;&nbsp;{"role": "user", "content": "Segunda mensagem do usu√°rio"}<br>
            ]
        </div>
        
        <button class="test-button" onclick="testHistoryFormat()">üß™ Testar Formata√ß√£o do Hist√≥rico</button>
        <button class="test-button" onclick="simulateConversation()">üí¨ Simular Conversa Completa</button>
        <button class="test-button" onclick="clearOutput()">üóëÔ∏è Limpar Output</button>
        
        <div id="output" class="test-output"></div>
    </div>

    <script type="module">
        import { ConversationHistoryManager } from './src/utils/ConversationHistoryManager.js';
        
        // Inst√¢ncia global para testes
        window.historyManager = new ConversationHistoryManager({
            debug: true,
            maxTokens: 4000
        });
        
        window.testHistoryFormat = function() {
            const output = document.getElementById('output');
            output.textContent = '';
            
            try {
                log('üß™ Testando formata√ß√£o do hist√≥rico...\n');
                
                // Limpa hist√≥rico anterior
                window.historyManager.startNewSession({
                    customerName: 'Jo√£o',
                    stage: 'greeting'
                });
                
                log('‚úÖ Nova sess√£o iniciada\n');
                
                // Simula uma conversa
                log('üìù Adicionando mensagens ao hist√≥rico...\n');
                
                const msg1 = window.historyManager.addUserMessage('Ol√°, como voc√™ est√°?');
                log(`‚û°Ô∏è Usu√°rio: "${msg1.content}" (role: ${msg1.role})\n`);
                
                const msg2 = window.historyManager.addAssistantMessage('Ol√°! Estou bem, obrigado. Como posso ajud√°-lo hoje?');
                log(`‚¨ÖÔ∏è Assistente: "${msg2.content}" (role: ${msg2.role})\n`);
                
                const msg3 = window.historyManager.addUserMessage('Preciso de informa√ß√µes sobre tratamentos faciais');
                log(`‚û°Ô∏è Usu√°rio: "${msg3.content}" (role: ${msg3.role})\n`);
                
                const msg4 = window.historyManager.addAssistantMessage('Claro! Oferecemos diversos tratamentos faciais. Voc√™ tem algum interesse espec√≠fico?');
                log(`‚¨ÖÔ∏è Assistente: "${msg4.content}" (role: ${msg4.role})\n`);
                
                const msg5 = window.historyManager.addUserMessage('Como eu disse que me chamo mesmo?');
                log(`‚û°Ô∏è Usu√°rio: "${msg5.content}" (role: ${msg5.role})\n`);
                
                // Prepara payload para API
                log('üîÑ Preparando payload para API...\n');
                const apiPayload = window.historyManager.prepareApiPayload();
                
                log('üìã PAYLOAD FINAL PARA API:\n');
                log(JSON.stringify(apiPayload, null, 2));
                log('\n');
                
                // Verifica se est√° correto
                let isCorrect = true;
                let errors = [];
                
                // Verifica se tem system message
                if (!apiPayload[0] || apiPayload[0].role !== 'system') {
                    isCorrect = false;
                    errors.push('‚ùå System message n√£o encontrado ou n√£o est√° primeiro');
                }
                
                // Verifica altern√¢ncia de roles
                for (let i = 1; i < apiPayload.length; i++) {
                    const msg = apiPayload[i];
                    
                    // Verifica se role √© v√°lida
                    if (!['user', 'assistant'].includes(msg.role)) {
                        isCorrect = false;
                        errors.push(`‚ùå Role inv√°lida na mensagem ${i}: "${msg.role}" (deveria ser "user" ou "assistant")`);
                    }
                    
                    // Verifica se n√£o h√° mensagens duplicadas
                    for (let j = i + 1; j < apiPayload.length; j++) {
                        if (apiPayload[i].content === apiPayload[j].content && apiPayload[i].role === apiPayload[j].role) {
                            isCorrect = false;
                            errors.push(`‚ùå Mensagem duplicada encontrada: "${msg.content.substring(0, 30)}..."`);
                        }
                    }
                }
                
                log('\nüìä RESULTADO DA VALIDA√á√ÉO:\n');
                if (isCorrect) {
                    log('‚úÖ FORMATA√á√ÉO CORRETA! O hist√≥rico est√° sendo formatado adequadamente.\n');
                } else {
                    log('‚ùå PROBLEMAS ENCONTRADOS:\n');
                    errors.forEach(error => log(error + '\n'));
                }
                
                // Mostra estat√≠sticas
                const sessionInfo = window.historyManager.getSessionInfo();
                log(`\nüìà ESTAT√çSTICAS:\n`);
                log(`- Total de mensagens no hist√≥rico: ${sessionInfo.messageCount}\n`);
                log(`- Total de mensagens no payload: ${apiPayload.length}\n`);
                log(`- Total de tokens estimados: ${sessionInfo.totalTokens}\n`);
                log(`- ID da sess√£o: ${sessionInfo.sessionId}\n`);
                
            } catch (error) {
                log(`‚ùå ERRO NO TESTE: ${error.message}\n`);
                log(`Stack trace: ${error.stack}\n`);
            }
        };
        
        window.simulateConversation = function() {
            const output = document.getElementById('output');
            output.textContent = '';
            
            try {
                log('üí¨ Simulando conversa completa...\n');
                
                // Nova sess√£o
                window.historyManager.startNewSession({
                    customerName: 'Maria Silva',
                    stage: 'greeting'
                });
                
                // Conversa simulada
                const conversation = [
                    { role: 'user', content: 'Oi, tudo bem?' },
                    { role: 'assistant', content: 'Ol√° Maria! Tudo √≥timo, obrigado por perguntar. Como posso ajud√°-la hoje?' },
                    { role: 'user', content: 'Quero saber sobre tratamentos para rugas' },
                    { role: 'assistant', content: 'Perfeito! Temos v√°rias op√ß√µes para tratamento de rugas. Voc√™ prefere tratamentos mais suaves ou est√° aberta a procedimentos mais intensivos?' },
                    { role: 'user', content: 'Prefiro algo mais suave primeiro' },
                    { role: 'assistant', content: '√ìtima escolha! Para come√ßar, recomendo nosso tratamento com √°cido hialur√¥nico e vitamina C. √â muito eficaz e suave.' },
                    { role: 'user', content: 'Como eu disse que me chamo mesmo?' }
                ];
                
                // Adiciona mensagens alternadamente
                conversation.forEach((msg, index) => {
                    if (msg.role === 'user') {
                        window.historyManager.addUserMessage(msg.content);
                        log(`${index + 1}. üë§ Usu√°rio: "${msg.content}"\n`);
                    } else {
                        window.historyManager.addAssistantMessage(msg.content);
                        log(`${index + 1}. ü§ñ Assistente: "${msg.content}"\n`);
                    }
                });
                
                log('\nüîÑ Preparando payload final...\n');
                const finalPayload = window.historyManager.prepareApiPayload();
                
                log('üìã PAYLOAD FINAL:\n');
                log(JSON.stringify(finalPayload, null, 2));
                
                // An√°lise do payload
                log('\nüîç AN√ÅLISE DO PAYLOAD:\n');
                finalPayload.forEach((msg, index) => {
                    const preview = msg.content.substring(0, 50) + (msg.content.length > 50 ? '...' : '');
                    log(`${index}. [${msg.role.toUpperCase()}] ${preview}\n`);
                });
                
                log(`\n‚úÖ Conversa simulada com ${finalPayload.length} mensagens no payload\n`);
                
            } catch (error) {
                log(`‚ùå ERRO NA SIMULA√á√ÉO: ${error.message}\n`);
            }
        };
        
        window.clearOutput = function() {
            document.getElementById('output').textContent = '';
        };
        
        function log(message) {
            const output = document.getElementById('output');
            output.textContent += message;
            output.scrollTop = output.scrollHeight;
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîç P√°gina de teste de formata√ß√£o carregada');
            console.log('üìä ConversationHistoryManager:', window.historyManager);
        });
    </script>
</body>
</html>